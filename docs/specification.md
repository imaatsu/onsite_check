# **命令書：Google Apps Script (GAS) を使った「現場チェックシステム」の開発（仕様兼AIコーディングのプロンプト例）**

あなたは、Google Apps Script (GAS) とGoogle Workspaceの連携に精通したプロの開発者です。これから定義する要件に従って、「現場チェックシステム」のGASコードを、claspでの管理に適した複数のファイル構成で作成してください。

## **1\. システム概要**

このシステムは、現場作業における問題点の発見から改善、最終承認までをGoogleフォームとスプレッドシートを用いて一元管理し、関係者への通知を自動化するものです。

**ワークフロー:**

1. **問題報告**: チェック担当者が、現場の問題点と写真を「問題報告フォーム」から送信する。  
2. **記録と通知**: 報告内容はスプレッドシートに記録され、GASが起動。当該現場の管理職にメールとSlackで自動通知する。このとき、改善報告用のフォームURLも自動生成して通知に含める。  
3. **改善報告**: 通知を受けた管理職が、問題を改善し、その内容と改善後の写真を「改善報告フォーム」から送信する。  
4. **記録の更新と承認依頼**: 改善報告は、元の問題報告と同じ行に記録される。同時に、最終承認者（社長など）に確認依頼の通知が飛ぶ。  
5. **最終承認**: 承認者がスプレッドシート上で内容を確認し、ステータスを「完了」に変更する。

## **2\. 前提条件 (Google環境の準備)**

以下のGoogleフォームとスプレッドシートが事前に準備されていることを前提とします。

### **A. Googleスプレッドシート： 現場チェック管理シート**

2つのシートで構成されます。

シート1: 報告一覧  
フォームからの回答が記録されるメインシート。

| 列 | A | B | C | D | E | F | G | H | I | J |
| :---- | :---- | :---- | :---- | :---- | :---- | :---- | :---- | :---- | :---- | :---- |
| **ヘッダー名** | タイムスタンプ | 管理ID | ステータス | 報告者名 | 現場場所 | 問題点の内容 | 問題点の写真 | 改善報告日時 | 改善内容 | 改善後の写真 |

シート2: 通知先マスタ  
現場場所と通知先を紐付けるマスタデータ。

| 列 | A | B | C | D |
| :---- | :---- | :---- | :---- | :---- |
| **ヘッダー名** | 現場場所 | 担当管理職名 | 通知先メールアドレス | Slack Webhook URL |
| **データ例** | A工場 | 田中 太郎 | tanaka@example.com | [https://hooks.slack.com/](https://hooks.slack.com/)... |
| **データ例** | B倉庫 | 鈴木 一郎 | suzuki@example.com | [https://hooks.slack.com/](https://hooks.slack.com/)... |

### **B. Googleフォーム1： 問題報告フォーム**

報告一覧シートに回答が記録されるように連携設定済み。

* **質問項目**:  
  1. 報告者名 (テキスト)  
  2. 現場場所 (プルダウン形式, 通知先マスタシートのA列と連動)  
  3. 問題点の内容 (段落テキスト)  
  4. 問題点の写真 (ファイルアップロード)

### **C. Googleフォーム2： 改善報告フォーム**

* **質問項目**:  
  1. 管理ID (テキスト, 事前入力)  
  2. 改善内容 (段落テキスト)  
  3. 改善後の写真 (ファイルアップロード)

## **3\. GASに実装する機能要件**

### **機能1: 問題報告時の自動処理 onProblemFormSubmit(e)**

* **トリガー**: 問題報告フォームが送信されたとき。  
* **処理内容**:  
  1. フォームから送信された情報（タイムスタンプ, 報告者名, 現場場所, 問題点, 写真URL）をイベントオブジェクト e から取得する。  
  2. 処理対象の行（最終行）を特定する。  
  3. その報告に一意の**管理ID**を生成する (例: yyyyMMdd-HHmmss)。生成したIDを報告一覧シートのB列に書き込む。  
  4. ステータスを「**対応待ち**」としてC列に書き込む。  
  5. 通知先マスタシートを参照し、報告された現場場所に紐づく**通知先メールアドレス**と**Slack Webhook URL**を取得する。  
  6. 改善報告フォームのURLを取得し、手順3で生成した**管理ID**を事前入力するパラメータを付与した**改善報告用のURL**を生成する。  
     * ヒント: form.getPublishedUrl() と pageHistory パラメータを使う。  
  7. 取得した通知先情報と生成したURLを使い、以下の内容でメールとSlackを送信する。  
     * **件名/タイトル**: 【現場チェック】\[現場場所\] より問題点の報告がありました  
     * **本文**:  
       * 管理ID  
       * 報告日時  
       * 報告者  
       * 現場場所  
       * 問題点の内容  
       * 問題点の写真へのリンク（またはインライン表示）  
       * **改善報告フォームへのリンク（最重要）**  
  8. すべての処理が完了したら、ステータスを「**通知済み**」に更新する。

### **機能2: 改善報告時の自動処理 onCorrectionFormSubmit(e)**

* **トリガー**: 改善報告フォームが送信されたとき。  
* **処理内容**:  
  1. フォームから送信された情報（管理ID, 改善内容, 改善後の写真URL）をイベントオブジェクト e から取得する。  
  2. 受け取った管理IDをキーにして、報告一覧シートのB列を検索し、該当する行を特定する。  
  3. 特定した行のH, I, J列に、それぞれ「改善報告日時」「改善内容」「改善後の写真URL」を書き込む。  
  4. 該当行のステータスを「**承認待ち**」に更新する。  
  5. **最終承認者**（社長など、固定のメールアドレスでOK）に、承認依頼のメールを送信する。  
     * **件名**: 【現場チェック承認依頼】\[現場場所\] の改善が報告されました  
     * **本文**:  
       * 管理ID  
       * 問題報告の内容と改善報告の内容を並べて記載  
       * **報告一覧シートの該当行への直接リンク**を含める (例: spreadsheet.getUrl() \+ '\#gid=0\&range=A10')

## **4\. コードに関する指示**

* **ファイル構成**: claspで管理しやすいように、以下のファイル構成を推奨します。  
  * main.gs: トリガーから呼び出されるメイン関数 (onProblemFormSubmit, onCorrectionFormSubmit) を配置。  
  * spreadsheetUtils.gs: スプレッドシートの読み書きに特化した関数をまとめる。  
  * notificationUtils.gs: メール送信やSlack通知の関数をまとめる。  
  * config.gs: スプレッドシートIDやフォームID、最終承認者のメールアドレスなどの設定値を定数としてまとめる。（アドレス等はスクリプトプロパティに保存）
* **可読性**: 日本語で詳細なコメントを各機能や処理ブロックごとに追加してください。変数名や関数名も処理内容が推測しやすいように命名してください。  
* **エラー処理**: try...catchブロックを用いて、メール送信失敗などの外部API呼び出しでエラーが発生した場合に、Logger.logでエラー内容を記録するようにしてください。

以上の要件を満たす、完全なGoogle Apps Scriptのコード一式を作成してください。