# **命令書：Google Apps Script (GAS) を使った「現場チェックシステム」の開発**

あなたは、Google Apps Script (GAS) とGoogle Workspaceの連携に精通したプロの開発者です。これから定義する要件に従って、「現場チェックシステム」のGASコードを、claspでの管理に適した複数のファイル構成で作成してください。

## **1\. システム概要**

このシステムは、現場作業における問題点の発見から改善、最終承認までをGoogleフォームとスプレッドシートを用いて一元管理し、関係者への通知を自動化するものです。

**ワークフロー:**

1. **問題報告**: チェック担当者が、現場の問題点と写真を「問題報告フォーム」から送信する。  
2. **記録と通知**: 報告内容はスプレッドシートに記録され、GASが起動。当該現場の管理職にメールとSlackで自動通知する。このとき、改善報告用のフォームURLも自動生成して通知に含める。  
3. **改善報告**: 通知を受けた管理職が、問題を改善し、その内容と改善後の写真を「改善報告フォーム」から送信する。  
4. **記録の更新と承認依頼**: 改善報告は、元の問題報告と同じ行に記録される。同時に、最終承認者（社長など）に確認依頼の通知が飛ぶ。  
5. **最終承認**: 承認者がスプレッドシート上で内容を確認し、ステータスを「完了」に変更する。

## **2\. 前提条件 (Google環境の準備)**

以下のGoogleフォームとスプレッドシートが事前に準備されていることを前提とします。

### **A. Googleスプレッドシート： 現場チェック管理シート**

2つのシートで構成されます。

シート1: 報告一覧  
フォームからの回答が記録されるメインシート。

| 列 | A | B | C | D | E | F | G | H | I | J |
| :---- | :---- | :---- | :---- | :---- | :---- | :---- | :---- | :---- | :---- | :---- |
| **ヘッダー名** | タイムスタンプ | 管理ID | ステータス | 報告者名 | 現場場所 | 問題点の内容 | 問題点の写真 | 改善報告日時 | 改善内容 | 改善後の写真 |

シート2: 通知先マスタ  
現場場所と通知先を紐付けるマスタデータ。

| 列 | A | B | C | D |
| :---- | :---- | :---- | :---- | :---- |
| **ヘッダー名** | 現場場所 | 担当管理職名 | 通知先メールアドレス | Slack Webhook URL |
| **データ例** | A工場 | 田中 太郎 | tanaka@example.com | [https://hooks.slack.com/](https://hooks.slack.com/)... |
| **データ例** | B倉庫 | 鈴木 一郎 | suzuki@example.com | [https://hooks.slack.com/](https://hooks.slack.com/)... |

### **B. Googleフォーム1： 問題報告フォーム**

報告一覧シートに回答が記録されるように連携設定済み。

* **質問項目**:  
  1. 報告者名 (テキスト)  
  2. 現場場所 (プルダウン形式, 通知先マスタシートのA列と連動)  
  3. 問題点の内容 (段落テキスト)  
  4. 問題点の写真 (ファイルアップロード)

### **C. Googleフォーム2： 改善報告フォーム**

* **質問項目**:  
  1. 管理ID (テキスト, 事前入力)  
  2. 改善内容 (段落テキスト)  
  3. 改善後の写真 (ファイルアップロード)

## **3\. GASに実装する機能要件**

### **機能1: 問題報告時の自動処理 onProblemFormSubmit(e)**

* **トリガー**: 問題報告フォームが送信されたとき。  
* **処理内容**:  
  1. フォームから送信された情報（タイムスタンプ, 報告者名, 現場場所, 問題点, 写真URL）をイベントオブジェクト e から取得する。  
  2. 処理対象の行（最終行）を特定する。  
  3. その報告に一意の**管理ID**を生成する (例: yyyyMMdd-HHmmss)。生成したIDを報告一覧シートのB列に書き込む。  
  4. ステータスを「**対応待ち**」としてC列に書き込む。  
  5. 通知先マスタシートを参照し、報告された現場場所に紐づく**通知先メールアドレス**と**Slack Webhook URL**を取得する。  
  6. 改善報告フォームのURLを取得し、手順3で生成した**管理ID**を事前入力するパラメータを付与した**改善報告用のURL**を生成する。  
     * ヒント: form.getPublishedUrl() と pageHistory パラメータを使う。  
  7. 取得した通知先情報と生成したURLを使い、以下の内容でメールとSlackを送信する。  
     * **件名/タイトル**: 【現場チェック】\[現場場所\] より問題点の報告がありました  
     * **本文**:  
       * 管理ID  
       * 報告日時  
       * 報告者  
       * 現場場所  
       * 問題点の内容  
       * 問題点の写真へのリンク（またはインライン表示）  
       * **改善報告フォームへのリンク（最重要）**  
  8. すべての処理が完了したら、ステータスを「**通知済み**」に更新する。

### **機能2: 改善報告時の自動処理 onCorrectionFormSubmit(e)**

* **トリガー**: 改善報告フォームが送信されたとき。  
* **処理内容**:  
  1. フォームから送信された情報（管理ID, 改善内容, 改善後の写真URL）をイベントオブジェクト e から取得する。  
  2. 受け取った管理IDをキーにして、報告一覧シートのB列を検索し、該当する行を特定する。  
  3. 特定した行のH, I, J列に、それぞれ「改善報告日時」「改善内容」「改善後の写真URL」を書き込む。  
  4. 該当行のステータスを「**承認待ち**」に更新する。  
  5. **最終承認者**（社長など、固定のメールアドレスでOK）に、承認依頼のメールを送信する。  
     * **件名**: 【現場チェック承認依頼】\[現場場所\] の改善が報告されました  
     * **本文**:  
       * 管理ID  
       * 問題報告の内容と改善報告の内容を並べて記載  
       * **報告一覧シートの該当行への直接リンク**を含める (例: spreadsheet.getUrl() \+ '\#gid=0\&range=A10')

## **4\. コードに関する指示**

* **ファイル構成**: claspで管理しやすいように、以下のファイル構成を推奨します。  
  * main.gs: トリガーから呼び出されるメイン関数 (onProblemFormSubmit, onCorrectionFormSubmit) を配置。  
  * spreadsheetUtils.gs: スプレッドシートの読み書きに特化した関数をまとめる。  
  * notificationUtils.gs: メール送信やSlack通知の関数をまとめる。  
  * config.gs: スプレッドシートIDやフォームID、最終承認者のメールアドレスなどの設定値を定数としてまとめる。  
* **可読性**: 日本語で詳細なコメントを各機能や処理ブロックごとに追加してください。変数名や関数名も処理内容が推測しやすいように命名してください。  
* **エラー処理**: try...catchブロックを用いて、メール送信失敗などの外部API呼び出しでエラーが発生した場合に、Logger.logでエラー内容を記録するようにしてください。

以上の要件を満たす、完全なGoogle Apps Scriptのコード一式を作成してください。

**5\. 質問に対する回答**
ご質問ありがとうございます。以下に回答します。この仕様で開発を進めてください。

トリガー種別について

はい、**「スプレッドシートの onFormSubmit トリガー」**でお願いします。イベントオブジェクト e から提出された値やスプレッドシートの情報を取得する方式が望ましいです。

管理IDと改善報告フォームのURLについて

管理IDの一意性: ご提案の通り、衝突を避けるため yyyyMMdd-HHmmss-SSS (ミリ秒まで) の形式でお願いします。

改善報告フォームのURL生成: FormAppの toPrefilledUrl() メソッドを使用してください。config.gs などで改善報告フォームの「管理ID」質問項目のIDを定数として保持し、それを使って事前入力URLを生成する方式でお願いします。

添付ファイルのアクセス権について

アップロードされた写真ファイルは、GASで**「組織（ドメイン）内のリンクを知っている全員が閲覧可能」**に権限を自動変更してください。これにより、通知を受け取った管理職や承認者がリンクをクリックするだけで写真を確認できるようにします。

Slack通知の仕様について

方式: 「Incoming Webhook」 を使用する前提で問題ありません。

メッセージ形式: 視認性を高めるため、プレーンテキストではなく 「Block Kit」 を使用したリッチな表示でお願いします。

通知先が未設定時の動作について

マスタシートでメールアドレスかSlack Webhook URLの片方のみが設定されている場合は、設定されている方にのみ通知を送信してください。両方とも未設定の場合は、通知をスキップし、GASの実行ログにその旨を記録してください。処理を中断する必要はありません。

最終承認者について

はい、config.gs に固定のメールアドレスを一つ設定する形で問題ありません。現時点では複数宛先やCCは不要です。

承認リンクについて

はい、ご提案の通り、スプレッドシートURLの末尾に #gid=...&range=A{row} を付与し、該当行のA列に直接飛ぶリンクを生成してください。

タイムゾーンについて

はい、日時の生成やフォーマットは、スプレッドシートのタイムゾーン (SpreadsheetApp.getActive().getSpreadsheetTimeZone()) に合わせてください。

ステータス遷移（エラー時）について

通知処理などでエラーが発生した場合は、ログ記録だけでなく、ユーザーが状況を把握できるよう、スプレッドシートのステータスを**「通知エラー」**のように更新してください。

複数通知先について

はい、1現場につき、通知先は1メールアドレス・1Webhook URLという前提で問題ありません。複数宛先への対応は不要です。

セットアップ関数について

setup() 関数の用意は不要です。トリガーは手動で設定します。

写真が複数枚の場合の対応

はい、ご提案の通り、複数ファイルが添付された場合は、スプレッドシートのセルには**「カンマ区切りの複数URL」を格納してください。メールやSlackの通知本文にも、同様に複数の写真リンクを並べて記載**する形でお願いします。

メール本文の画像表示

はい、メール本文は**「リンクのみ」**の送付で問題ありません。インライン画像の埋め込みは不要です。

権限変更の失敗時の動作

権限変更に失敗した場合の動作として、ステータスは変更せず（「通知済み」のまま）、エラー内容をログに記録するのみ、という仕様で問題ありません。通知自体は届いているため、その運用で大丈夫です。

日時フォーマット

日時フォーマットは、ご提案いただいた yyyy/MM/dd HH:mm:ss で統一してください。それで問題ありません。

## **6\. 改善提案 **
1. main.gs：フォームの回答取得方法の改善
onCorrectionFormSubmit関数内で、フォームの回答を e.namedValues（質問名と回答のペア）から取得しています。

JavaScript

// main.gs L:100 付近 (現在のコード)
const named = e && e.namedValues ? e.namedValues : {};
// ...
const managementId = String(pick(['管理ID'])).trim();
この方法は質問のタイトルを変更すると動かなくなるため、少し不安定です。
e.values（回答が順番に入った配列）を使い、回答がスプレッドシートのどの列に入るかを基準に取得する方がより堅牢になります。

【提案】
改善報告フォームの回答が、スプレッドシートの例えば L列 以降に一時的に書き込まれると仮定し、その列番号で値を取得します。（フォームの回答は通常、連携シートの新しい行に書き込まれます）

※改善報告は別シートに書き出す設定にして、そこから値を取得するのが最も安定します。ここでは、イベントオブジェクトから直接取る方法を改善する案を提示します。

JavaScript

// main.gs の onCorrectionFormSubmit 内 (改善案)
function onCorrectionFormSubmit(e) {
  try {
    // e.valuesはフォームの回答が送信された順に入った配列
    // [タイムスタンプ, 管理ID, 改善内容, 改善後の写真, ...] のような並びを想定
    const values = e.values;
    if (!values || values.length < 4) {
      Logger.log('Invalid event values');
      return;
    }

    const managementId = String(values[1]).trim(); // 2番目の質問が管理ID
    const correctionTextRaw = String(values[2]);   // 3番目の質問が改善内容
    const correctionPhotosRaw = String(values[3]); // 4番目の質問が写真
    // ...
2. spreadsheetUtils.gs：IDによる行検索の高速化
findRowByManagementId_関数は、上から1行ずつIDを比較しています。データが数千行程度なら問題ありませんが、将来的に数万行になる可能性がある場合、TextFinderを使うとより高速に検索できます。

JavaScript

// spreadsheetUtils.gs L:70 付近 (現在のコード)
function findRowByManagementId_(managementId) {
  // ... forループで1行ずつ比較 ...
}
【提案】

JavaScript

// spreadsheetUtils.gs (改善案)
function findRowByManagementId_(managementId) {
  const sheet = getReportSheet_();
  const range = sheet.getRange("B:B"); // 検索対象のB列全体
  const textFinder = range.createTextFinder(managementId);

  // 完全一致で検索
  textFinder.matchEntireCell(true);
  const foundRange = textFinder.findNext();

  if (foundRange) {
    return foundRange.getRow();
  }
  return -1;
}
3. notificationUtils.gs：HTML/JSONの分離
メール本文のHTMLやSlackのBlock KitをGASコード内で文字列として組み立てています。
これを HtmlService のテンプレート機能を使ってHTMLファイルとして分離すると、見た目の修正が簡単になり、コードがスッキリします。

【例】 approval-email.html というファイルを新規作成

HTML

<!-- approval-email.html -->
<!DOCTYPE html>
<html>
  <body>
    <p>以下の改善が報告されました。承認をお願いします。</p>
    <p><b>管理ID:</b> <?= managementId ?></p>
    <p><b>現場場所:</b> <?= place ?></p>
    <hr/>
    <h3>問題報告</h3>
    <p><b>報告日時:</b> <?= problemTimestamp ?></p>
    <!-- ... 以下略 ... -->
  </body>
</html>
【GAS側のコード】

JavaScript

// notificationUtils.gs (改善案)
function buildApprovalEmailHtml_(data) {
  const template = HtmlService.createTemplateFromFile('approval-email.html');
  // テンプレートにデータを渡す
  template.managementId = data.managementId;
  template.place = data.place;
  // ... 他のデータも同様にセット ...

  // HTMLを生成
  return template.evaluate().getContent();
}
これは少し大きな変更になりますが、通知の見た目を頻繁に変更する可能性がある場合に非常に有効です。